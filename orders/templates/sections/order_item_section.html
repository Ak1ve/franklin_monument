<!--
order:
cataloged_items
users: all users
-->

<h1 class="text-center">Items</h1>
<div class="d-flex justify-content-center">
    <button class="btn btn-success" type="button" onclick="order_item_modal_add()">Add Item</button>
</div>
<hr>
<div class="container bg-gradient-primary border p-2">
    <div class="list-group" id="order_item_list">
        {% for item in order.item_set.items.all %}
        {% include "common/order_item_card.html" with order_item=item %}
        {% endfor %}
    </div>
</div>
<script>
    function order_item_show_modal(refers) {
        let refer = refers ? refers : "";
        $(`{% include "common/order_item_modal.html" with cataloged_items=cataloged_items %} refers="${refer}"`).insertAfter("nav");
        $("#order_item_modal").modal("show");
        $(".selectpicker").selectpicker();
    }

    function order_item_modal_add() {
        order_item_show_modal();
        $("#order_item_type").change(function() {
            order_item_load_type($(this).val());
        });
        hide("#order_item_specs ~ *");
        hide("#order_item_specs");
    }

    function order_item_set_select(select_query, ids) {
        /*
        Sets <select>s to their given values; use for order_item_edit
        */
        ids = Array.isArray(ids) ? ids : [ids];
        $(`${select_query} option`).filter(function(i, e) {
            return ids.includes(Number.parseInt($(e).prop("value")));
        }).prop("selected", true).change();
    }

    function order_item_edit(item_id) {
        let element = $(`#order_item${item_id}`);
        order_item_show_modal(item_id);
        order_item_load_type(element.data("type"));
        $("#order_item_type").prop("disabled", true);
        $("#order_item_type").selectpicker("refresh");
        $("#order_item_modal").data("refers", item_id);
        hide("#order_item_task_set");
        sendHttpAsync(current_url + `/item/${item_id}`, "get").then(resp => {
            let obj = JSON.parse(resp.body);
            order_item_set_select("#order_item_type", obj.type_id);
            for (let spec of obj.specifications) {
                order_item_set_select(`#option${spec.option_id}`, spec.option_value_ids)
            }
            if (obj.dimensions !== null) {
                $("#order_item_dimensions input").each(function (i) {
                    $(this).val(obj.dimensions[i]);
                });
            }
            $("#order_item_price").val(obj.price);
            if (obj.tax_exempt) {
                $("#order_item_tax_exempt").prop("checked", true);
            }
            $("#order_item_notes").val(obj.notes);
        }).catch(err => {
            notify("danger", `ERROR: Could not fetch item ${err}`)
        })
    }

    function order_item_close_modal() {
        let modal = $("#order_item_modal");
        modal.modal("hide");
        $("body").removeClass('modal-open');
        $(".modal-backdrop").remove();
    }

    function order_item_render_json(body) {
        /*
        body is a CatalogedItemSend object
        */
        unhide("#order_item_specs ~ *");
        unhide("#order_item_specs");
        if (!body.sizeable) {
            hide("#order_item_dimensions");
        } else {
            unhide("#order_item_dimensions");
            $("#order_item_dimensions").find("input").val(0);
        }
        $("#order_item_type").prop("disabled", false);
        $("#order_item_price").val(0);
        let order_options = $("#order_item_options");
        let tasks = $("#order_item_tasks");
        order_options.children().remove();
        tasks.children().remove();

        for(const option of body.options) {
            order_options.append(`{% include "common/order_item_option.html" with label="${option.key}" id="option${option.id}" %}`);
            let select = $(`#option${option.id}`);
            if (option.allow_multi) {
                select.prop("multiple", true);
            } else if (option.allow_null) {
                select.append(`<option class="text-muted" value="null">None</option>`)
            }
            for (const option_value of option.values) {
                select.append(`<option data-subtext="${option_value.subtext}" value=${option_value.id}>${option_value.label}</option>"`);
            }
        }

        for (const task of body.tasks) {
            // TODO change users
            tasks.append(`{% include "common/order_item_task.html" with users=None id="${task.id}" name="${task.label}" description="${task.description}" %}`)
        }

        $(".selectpicker").selectpicker();
    }

    function order_item_load_type(id) {
        /*
        Loading type of a given id.  for #order_item_type.value
        */

        sendHttpAsync(`/orders/item/${id}`, "get").then(resp => {
            let body = JSON.parse(resp.body)
            order_item_render_json(body);
        }).catch(err => {
            order_item_close_modal();
            notify("danger", `ERROR: Could not fetch data for item type info: ${err}`)
        });
    }

    function order_item_send_edit(refers, body) {
        sendHttpAsync(current_url + `/item/${refers}`, "post", body).then(resp => {
            $(`#order_item${refers}`).replaceWith(resp.body.body);
            order_item_close_modal();
            notify_for("success", "Item changed successfully!", 3000);
        }).catch(err => {
            notify("danger", `ERROR: could not edit item: ${err}`);
            order_item_close_modal();
        });
    }

    function order_item_submit() {
        // submitting a POST response to /orders/<number>/item  TODO
        // Data modeled from models.OrderItemResponse
        let type_id = parseInt($("#order_item_type").val());
        let specifications = [];
        $("#order_item_options").children().each(function() {
            let select = $(this).find("select");
            let value = select.val();
            // im sorry
            value = Array.isArray(value) ? value : value === "null" ? []: [value];
            specifications.push({option_id: parseInt(select.prop("id").substring("option".length)), option_value_ids: value.map(x=>parseInt(x))});
        });
        let dimensions = [];
        $("#order_item_dimensions").find("input").each(function() {
            dimensions.push($(this).val());
        });
        if (!$("#order_item_dimensions").hasClass("transition")) {
            dimensions = null;
        }
        let price = $("#order_item_price").val();
        let tax_exempt = $("#order_item_tax_exempt").is(":checked");
        let notes = $("#order_item_notes").val();
        let tasks = [];
        $("#order_item_tasks").children().each(function() {
            let select = $(this).find("select");
            tasks.push({task_id: parseInt(select.prop("id").substring("task".length)), user_id: parseInt(select.val())});
        });
        let body = {
            type_id: type_id, specifications: specifications, dimensions: dimensions, price: price,
            tax_exempt: tax_exempt, notes: notes, tasks: tasks
        };
        let refers = $("#order_item_modal").data("refers");
        if (refers !== "") {
            order_item_send_edit(refers, body);
            return;
        }
        sendHttpAsync(current_url + "/item", "post", body).then(resp => {
            let element = $(resp.body.body);
            $("#order_item_list").append(element);
            order_item_close_modal();
        }).catch(err => {
            notify("danger", `ERROR: could not add item to order: ${err}`);
            order_item_close_modal();
        });
    }
    function order_item_confirm_delete(item_id) {
        sendHttpAsync(current_url + `/item/${item_id}`, "delete").then(resp => {
            notify_for("success", "Item Successfully deleted", 3000);
            $(`#order_item${item_id}`).remove();
            $(".modal_item_delete").remove();
        }).catch(err => {
            notify("danger", `ERROR: Could not delete item!: ${err}`);
            $(".modal_item_delete").remove();
        });
    }
    function order_item_delete(item_id) {
        let footer = `<button type="button" onclick="dismiss_modal(); $('.modal_item_delete').remove()" class="btn btn-secondary">Cancel</button><button type="button" class="btn btn-danger" onclick="order_item_confirm_delete(${item_id})">Delete</button>`;
        $(`{% include "common/modal.html" with id="modal_item_delete" body="Are you sure you want to delete this item? Doing so will remove current tasks.  This action cannot be undone" footer="${footer}" title="Are you sure you want to delete?"%}`).insertAfter("nav");
        $("#modal_item_delete").modal("show");
    }

</script>